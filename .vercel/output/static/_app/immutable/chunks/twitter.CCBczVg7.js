import{P as h}from"./public.CdQsj55-.js";function g(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";let r="";for(let a=0;a<128;a++)r+=e.charAt(Math.floor(Math.random()*e.length));return r}async function f(e){const t=new TextEncoder().encode(e),a=await crypto.subtle.digest("SHA-256",t);return btoa(String.fromCharCode(...new Uint8Array(a))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function o(...e){console.log("[Twitter Client]:",...e)}function i(...e){console.error("[Twitter Client Error]:",...e)}const w={generateAuthLink:async()=>{try{typeof window<"u"&&sessionStorage.clear(),o("Starting OAuth2 process");const e=crypto.randomUUID(),r=g(),t=await f(r);o("Generated state:",e),o("Generated codeVerifier:",r),o("Generated codeChallenge:",t),typeof window<"u"&&(sessionStorage.setItem("oauth_state",e),sessionStorage.setItem("code_verifier",r));const n=`https://twitter.com/i/oauth2/authorize?${new URLSearchParams({response_type:"code",client_id:h,redirect_uri:"http://localhost:5173/auth/callback",scope:"tweet.read users.read tweet.write offline.access",state:e,code_challenge:t,code_challenge_method:"S256"}).toString()}`;return o("Generated auth URL:",n),n}catch(e){throw i("Error in generateAuthLink:",e),e}},handleCallback:async(e,r)=>{try{o("Starting callback handling"),o("Received code:",e),o("Received state:",r);const t=sessionStorage.getItem("oauth_state"),a=sessionStorage.getItem("code_verifier");if(o("Stored state:",t),o("Stored codeVerifier:",a),!t||!a||t!==r)throw i("State verification failed"),new Error("Invalid state parameter");const n=await fetch("/api/twitter/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e,codeVerifier:a})});if(!n.ok){const l=await n.json();throw console.error("Token response error:",l),new Error("Failed to get access token")}const s=await n.json();console.log("Tokens received:",s);const c=await fetch("/api/twitter/user",{headers:{Authorization:`Bearer ${s.access_token}`}});if(!c.ok)throw new Error("Failed to get user data");const d=await c.json();return console.log("User data:",d),sessionStorage.removeItem("oauth_state"),sessionStorage.removeItem("code_verifier"),{user:d.data,accessToken:s.access_token,refreshToken:s.refresh_token||null}}catch(t){throw i("Error in handleCallback:",t),t}}};export{w as t};
